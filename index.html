<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base64 Decoder</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="panel">
            <h2>Base64 Input</h2>
            <textarea id="encodedInput" placeholder="여기에 Base64를 입력하면 아래에 결과가 표시됩니다..."></textarea>
            <h2>Decoded Output <div class="spinner" id="spinner"></div></h2>
            <div id="decodedOutput"></div>
            <div class="settings">
                <span>Auto Redirect</span>
                <label class="switch">
                    <input type="checkbox" id="autoRedirectToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <script>
        const encodedInput = document.getElementById('encodedInput');
        const decodedOutput = document.getElementById('decodedOutput');
        const spinner = document.getElementById('spinner');
        const autoRedirectToggle = document.getElementById('autoRedirectToggle');
        const footerText = document.querySelector('.footer p');
        let redirectTimer = null;
        let countdownTimer = null;

        function b64DecodeUnicode(str) {
            try {
                return decodeURIComponent(atob(str).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
            } catch (e) {
                return atob(str); // Fallback for non-UTF8 strings
            }
        }

        function resetState() {
            clearTimeout(redirectTimer);
            clearInterval(countdownTimer);
            footerText.textContent = 'URL로 디코딩되면 잠시 후 자동으로 리다이렉트됩니다.';
        }

        encodedInput.addEventListener('input', () => {
            spinner.style.display = 'block';
            resetState();

            setTimeout(() => {
                try {
                    const base64 = encodedInput.value;
                    if (base64.trim() === '') {
                        decodedOutput.textContent = '';
                        spinner.style.display = 'none';
                        return;
                    }
                    const decodedText = b64DecodeUnicode(base64);
                    decodedOutput.textContent = decodedText;

                    const urlPattern = /^(https?:\/\/)?((([a-z\d]([a-z\d-]*[a-z\d])*)\.)+[a-z]{2,}|((\d{1,3}\.){3}\d{1,3}))(:\d+)?(\/[-a-z\d%_.~+]*)*(\?[;&a-z\d%_.~+=-]*)?(#[-a-z\d_]*)?$/i;
                    
                    if (autoRedirectToggle.checked && urlPattern.test(decodedText)) {
                        let countdown = 3;
                        footerText.textContent = `URL Found. Redirecting in ${countdown}...`;

                        countdownTimer = setInterval(() => {
                            countdown--;
                            if (countdown > 0) {
                                footerText.textContent = `Redirecting in ${countdown}...`;
                            }
                        }, 1000);

                        redirectTimer = setTimeout(() => {
                            let url = decodedText;
                            if (!url.startsWith('http')) {
                                url = 'http://' + url;
                            }
                            window.location.href = url;
                        }, 3000); // 3초 후 리다이렉트
                    }

                } catch (e) {
                    decodedOutput.textContent = `Error: ${e.message}`;
                }
                spinner.style.display = 'none';
            }, 50);
        });
    </script>
</body>
</html>